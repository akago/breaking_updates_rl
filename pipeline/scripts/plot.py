import os
import json
import pandas as pd
import matplotlib
matplotlib.use("Agg")
import matplotlib.pyplot as plt
from pathlib import Path
from collections import Counter
from matplotlib.ticker import MaxNLocator

root_dir = Path(__file__).parent.parent.parent

index_file = str(root_dir / "dataset_metadata.json")


with open(index_file, "r", encoding="utf-8") as f:
    index_data = json.load(f)

sample_files = index_data.get("success", [])


projects = []
file_counts_per_sample = []
error_counts_per_sample = []
for breaking_commit in sample_files:
    fpath = root_dir / "data" / "dataset" / breaking_commit / "context.json"
    if not fpath.exists():
        continue
    with open(fpath, "r", encoding="utf-8") as f:
        meta = json.load(f)
        project = meta.get("project")
        if project:
            projects.append(project)

            # Count errors in this project
            buggy_files = meta.get("buggyFiles", {}) or {}
            n_errors = sum(len(err_list) for err_list in buggy_files.values())
            n_files = len(buggy_files.keys())
            file_counts_per_sample.append(int(n_files))
            error_counts_per_sample.append(int(n_errors))
            

df = pd.DataFrame(projects, columns=["project"])
print(df["project"].value_counts())
project_counts = df.value_counts().reset_index(name="num_commits")
project_counts.columns = ["project", "num_commits"]

save_dir = root_dir / "statistics"

# ---- Bar chart: commits per project 
plt.figure(figsize=(12,6))
plt.bar(project_counts["project"], project_counts["num_commits"])
plt.xticks(rotation=45, ha="right")
plt.ylabel("Number of Breaking Commits")
plt.title("Distribution of Breaking Commits per Project")
plt.text(
    0.99, 0.95,
    f"Total samples: {len(projects)} across {project_counts.shape[0]} projects",
    ha="right", va="top", transform=plt.gca().transAxes,
    fontsize=10, color="dimgray"
)
plt.tight_layout()
plt.savefig(save_dir / "project_distribution_bar.png", dpi=200, bbox_inches="tight")
plt.show()
plt.close()


#  how many projects have N commits
max_cnt = int(project_counts["num_commits"].max())
bins = range(1, max_cnt + 2)
plt.figure(figsize=(8, 5))
plt.hist(project_counts["num_commits"], bins=bins, align="left", rwidth=0.9)
plt.xlabel("Breaking commits per project")
plt.ylabel("Number of projects")
plt.title("Distribution of Project Frequencies")
plt.xticks(range(1, max_cnt + 1))
plt.tight_layout()
hist_path = save_dir / "project_distribution_hist.png"
plt.savefig(hist_path, dpi=200, bbox_inches="tight")
plt.close()

# how many projects have N buggy files
plt.figure(figsize=(8, 5))
plt.hist(file_counts_per_sample, bins=range(max(file_counts_per_sample)+2), align="left", rwidth=0.9)
plt.xlabel("Number of Buggy Files per Sample (N)")
plt.ylabel("Number of Samples")
plt.title("Distribution of Buggy Files per Sample")
plt.text(
    0.99, 0.95,
    f"Total buggy files number: {sum(file_counts_per_sample)} across {len(projects)} samples",
    ha="right", va="top", transform=plt.gca().transAxes,
    fontsize=10, color="dimgray"
)
ax = plt.gca()
ax.xaxis.set_major_locator(MaxNLocator(integer=True))
plt.tight_layout()
file_hist_path = save_dir / "file_distribution_hist.png"
plt.savefig(file_hist_path, dpi=200, bbox_inches="tight")
plt.close()

# how many projects have N errors
 
plt.figure(figsize=(8, 5))
plt.hist(error_counts_per_sample, bins=range(max(error_counts_per_sample)+2), align="left", rwidth=0.9)
plt.xlabel("Number of Errors per Sample (N)")
plt.ylabel("Number of Samples")
plt.title("Distribution of Errors per Sample")
plt.text(
    0.99, 0.95,
    f"Total errors: {sum(error_counts_per_sample)} across {len(projects)} samples",
    ha="right", va="top", transform=plt.gca().transAxes,
    fontsize=10, color="dimgray"
)
plt.tight_layout()

error_hist_path = save_dir / "error_distribution_hist.png"
plt.savefig(error_hist_path, dpi=200, bbox_inches="tight")
plt.close()


input_dict = {
    "input_dis": [
        17556,
        8607,
        3702,
        1644,
        1598,
        49028,
        1494,
        2271,
        8493,
        2792,
        2060,
        4368,
        6153,
        1584,
        4135,
        1966,
        1241,
        7650,
        1345,
        2016,
        1339,
        6562,
        1634,
        1680,
        3478,
        3421,
        2823,
        6036,
        1747,
        1369,
        2964,
        10496,
        8849,
        14130,
        2061,
        9324,
        1558,
        8578,
        10152,
        1483,
        9297,
        4937,
        9294,
        3916,
        2408,
        9269,
        11996,
        4149,
        1431,
        3411,
        14504,
        8578,
        1225,
        2583,
        6315,
        1942,
        4861,
        49028,
        3967,
        4302,
        1807,
        7067,
        1862,
        3395,
        13623,
        8699,
        5499,
        2083,
        1733,
        6964,
        4781,
        7860,
        2118,
        2444,
        4787,
        5196,
        5267,
        8578,
        16264,
        1108,
        6216,
        1791,
        1487,
        2995,
        1807,
        2944,
        1826,
        3714,
        6726,
        3595,
        1855,
        2248,
        5787,
        2530,
        3411,
        13480,
        3583,
        6036,
        1647,
        2792,
        6036,
        1826,
        6344,
        8420,
        1501,
        9759,
        1647,
        8455,
        1936,
        3040,
        3409,
        60558,
        19967,
        1487,
        7678,
        4174,
        4775,
        1956,
        5389,
        2711,
        1314,
        1536,
        8117,
        2976,
        18562,
        6000,
        3627,
        13689,
        6538,
        17692,
        8578,
        6036,
        2718,
        1498,
        1807,
        2091,
        3923,
        4239,
        2177,
        2271,
        1972,
        8493,
        68182,
        2271,
        3651,
        9759,
        2430,
        1419,
        4354,
        5399,
        10427,
        14504,
        14560,
        2543,
        4222,
        11216,
        1674,
        1850,
        8578,
        3583,
        1381,
        19885,
        1758,
        1192,
        2009,
        3012,
        1584,
        8493,
        1242,
        3359,
        3906,
        1951,
        3477,
        1758,
        2405,
        1614,
        1903,
        1465,
        1447,
        1745,
        4568,
        8493,
        3080,
        2408,
        2891,
        1654,
        2681,
        1598,
        5399,
        2677,
        1592,
        4286,
        2792,
        1775,
        1245,
        2254,
        3883,
        2271,
        1777,
        2897,
        4368,
        9761,
        2512,
        1569,
        2139,
        10757,
        2108,
        2009,
        4775,
        2254,
        2792,
        3374,
        1634,
        6118,
        1647,
        2670,
        1842,
        6434,
        5399,
        2792,
        1558,
        5267,
        5913,
        1966,
        1410,
        1241,
        1410,
        1345,
        4302,
        7188,
        2016,
        9248,
        1339,
        4225,
        1680,
        3411,
        3421,
        2897,
        1747,
        6036,
        1942,
        1779,
        1369,
        1654,
        3763,
        1501,
        429334,
        17239,
        7224,
        4961,
        2550,
        5267,
        1779,
        8578,
        1095,
        5272,
        1369,
        2309,
        2254,
        63441,
        6315,
        8578,
        5267,
        2476,
        68456,
        4502,
        4036,
        6537,
        5104,
        1944,
        63795,
        1733,
        8578,
        4775,
        2995,
        3590,
        3096,
        2905,
        6036,
        1644,
        3500,
        3999,
        1431,
        6216,
        1410,
        2995,
        2538,
        2029,
        6153,
        1410,
        1826,
        8455,
        2551,
        3115,
        2096,
        3595,
        1647,
        1487,
        1614,
        1501,
        3888,
        2305,
        2550,
        1862,
        3931,
        4973,
        1674,
        6036,
        3978,
        3101,
        3590,
        1636,
        3850,
        2206,
        3399,
        1800,
        2550,
        2271,
        3923,
        5532,
        4253,
        11216,
        2465,
        1654,
        2309,
        3651,
        24503,
        5272,
        2509,
        3931,
        4775,
        3931,
        8493,
        2286,
        1950,
        16168,
        3931,
        3411,
        1850,
        923,
        4775,
        2749,
        3399,
        1369,
        5267,
        8442,
        8493,
        1654,
        2254,
        3284,
        4709,
        7466,
        19096,
        10009,
        8455,
        10086,
        1903,
        9707,
        1644,
        2550,
        9594,
        10352,
        1487,
        10013,
        524577,
        3411,
        9550,
        7430,
        4367,
        63715,
        1501,
        6229,
        1349,
        4781,
        5267,
        909,
        60284,
        1614,
        4775,
        3846,
        15770,
        64069,
        3050
    ],
    "output_dis": [
        18998,
        12157,
        6444,
        2350,
        2149,
        97434,
        1848,
        3841,
        13502,
        4517,
        3536,
        6992,
        10884,
        2037,
        5591,
        2396,
        1562,
        10677,
        1776,
        2530,
        1581,
        11568,
        2231,
        2318,
        4872,
        5234,
        4229,
        11434,
        2536,
        1969,
        5284,
        11607,
        8944,
        27583,
        3540,
        9761,
        2178,
        13672,
        11244,
        1888,
        9611,
        7758,
        9715,
        6934,
        3779,
        9652,
        13821,
        4936,
        2029,
        5136,
        27437,
        13672,
        1731,
        3646,
        11798,
        2842,
        7879,
        97434,
        4605,
        7916,
        2903,
        12487,
        2585,
        5291,
        25619,
        12546,
        7658,
        2905,
        2635,
        8780,
        5502,
        11873,
        3655,
        4097,
        5849,
        9640,
        5900,
        13672,
        17985,
        1412,
        10580,
        2546,
        2358,
        5416,
        2903,
        5109,
        2581,
        6384,
        12007,
        5287,
        2397,
        3868,
        9775,
        4425,
        5136,
        21997,
        6598,
        11434,
        2678,
        4517,
        11434,
        2581,
        6917,
        15750,
        2386,
        17982,
        2678,
        15785,
        3213,
        4088,
        5185,
        61211,
        22438,
        2358,
        11628,
        7490,
        5490,
        2639,
        9089,
        4840,
        1862,
        2380,
        10981,
        5363,
        21282,
        7707,
        5167,
        16035,
        12244,
        19258,
        13672,
        11434,
        4229,
        1792,
        2903,
        2846,
        5883,
        7088,
        3047,
        3841,
        3235,
        13502,
        76363,
        3841,
        6187,
        17982,
        2780,
        2121,
        5496,
        8581,
        13872,
        27437,
        27493,
        3089,
        5595,
        20609,
        2514,
        2677,
        13672,
        6598,
        1897,
        22405,
        2945,
        1662,
        2516,
        4885,
        2037,
        13502,
        1783,
        4120,
        4608,
        3090,
        4799,
        2945,
        3119,
        2393,
        2618,
        1893,
        2189,
        2503,
        5237,
        13502,
        4661,
        3779,
        4932,
        2692,
        4449,
        2149,
        8581,
        4192,
        2261,
        5381,
        4517,
        2626,
        1539,
        3892,
        6616,
        3841,
        2639,
        5168,
        6992,
        12631,
        4107,
        2218,
        3260,
        15403,
        3184,
        2516,
        5490,
        3892,
        4517,
        5840,
        2231,
        10849,
        2678,
        3992,
        2597,
        11446,
        8581,
        4517,
        2178,
        5900,
        10024,
        2396,
        2054,
        1562,
        2054,
        1776,
        7916,
        9715,
        2530,
        10181,
        1581,
        7091,
        2318,
        5136,
        5234,
        5168,
        2536,
        11434,
        2842,
        2313,
        1969,
        2692,
        6871,
        2386,
        855212,
        19048,
        9162,
        9176,
        4483,
        5900,
        2526,
        13672,
        1415,
        5910,
        1969,
        3747,
        3892,
        66982,
        11798,
        13672,
        5900,
        2965,
        76637,
        7520,
        6186,
        11764,
        9393,
        3170,
        67145,
        2635,
        13672,
        5490,
        5416,
        6332,
        4082,
        5096,
        11434,
        2350,
        4923,
        5584,
        2029,
        10580,
        2054,
        5416,
        3972,
        2834,
        10884,
        2054,
        2581,
        15785,
        3754,
        5579,
        2971,
        5287,
        2678,
        2358,
        2013,
        2386,
        5218,
        3778,
        4483,
        2585,
        7138,
        6751,
        2514,
        11434,
        6914,
        4082,
        6332,
        2114,
        6344,
        3528,
        5460,
        2660,
        4483,
        3841,
        5883,
        9680,
        5314,
        20609,
        3976,
        2692,
        3121,
        6187,
        43425,
        5910,
        3200,
        7138,
        5490,
        7138,
        13502,
        2529,
        2724,
        17805,
        7138,
        5136,
        2677,
        1217,
        5490,
        3592,
        5460,
        1969,
        5900,
        13390,
        13502,
        2692,
        3892,
        5545,
        8209,
        13205,
        22059,
        11001,
        15785,
        10789,
        2618,
        10201,
        2350,
        4483,
        10120,
        11227,
        2358,
        10646,
        1043431,
        5136,
        10355,
        9984,
        7319,
        67256,
        2386,
        9067,
        1825,
        5502,
        5900,
        1088,
        60937,
        2393,
        5490,
        5197,
        17717,
        67419,
        3689
    ],
    "exceeded_samples": 33
}

input_output_dis = input_dict["output_dis"]

plt.figure(figsize=(8, 5))
plt.hist(error_counts_per_sample, bins=range(max(error_counts_per_sample)+2), align="left", rwidth=0.9)
plt.xlabel("Number of Errors per Sample (N)")
plt.ylabel("Number of Samples")
plt.title("Distribution of Errors per Sample")
plt.text(
    0.99, 0.95,
    f"Total errors: {sum(error_counts_per_sample)} across {len(projects)} samples",
    ha="right", va="top", transform=plt.gca().transAxes,
    fontsize=10, color="dimgray"
)
plt.tight_layout()

error_hist_path = save_dir / "error_distribution_hist.png"
plt.savefig(error_hist_path, dpi=200, bbox_inches="tight")
plt.close()
# table view
# import caas_jupyter_tools
# caas_jupyter_tools.display_dataframe_to_user("Project distribution", project_counts)